## 次の改善候補（小さな改善/追加仕様）

現状の作業完了状態: `ft_readline`, `shell_loop`, `free_shell` 相当の契約を追加済み（初版）。

次の作業（本ドキュメントの進め方・提案）
 - 優先度順（推奨）
   1. `lexer` と `lexer_utils`（字句解析のトークン仕様とエラーパターンを明確化）
   2. `word_list` / `word_expansion`（展開ルールの詳細化、特に `$` と `*` の優先度）
   3. `parser`（AST ノード仕様、gen_command_node の入出力）
   4. `executer`（fork/exec の契約、リダイレクトとパイプの期待動作）

 - 1〜4 を関数レベル（主要関数のシグネチャ、入出力、失敗時の返り値、代表的副作用）で順次追加していきます。

どれを最初に詳細化しましょうか？（`lexer` を最優先で進めるのが一番影響が大きく、続けて `word_expansion` が良いです）
# モジュール役割定義書

この文書は、`minishell` リポジトリ内の各モジュール（ディレクトリ／主要ソース単位）の責務、主要な公開インタフェース、入力／出力、エラーモード、影響範囲、及び単体／統合テストの提案をまとめたものです。

注意: libftレベル（`ft_*` 基本ユーティリティ）の個々の関数は本書の対象外です。対象は「機能的レイヤー」であり、例えば `cleanup_after_line`, `check_syntax` 相当の粒度から記述します。

目次
- 全体アーキテクチャ概要
- 主要データ構造（概観）
- 各モジュール（ファイル群）と責務
  - `src/main.c` / `src/shell_loop_utils.c`
  - `src/ft_readline`（readlineラッパー）
  - `src/lexer` / `src/lexer/*`（字句解析）
  - `src/lexer/word_expansion`（ワード展開）
  - `src/lexer/word_list`（ワード単位分解 / ノード）
  - `src/parser`（構文解析 / AST生成 / 文法チェック）
  - `src/executer`（実行器）
    - `executor_utils/ast_traversal_utils`（AST巡回と実行）
    - `executor_utils/heredoc`（ヒアドキュメント）
    - `executor_utils/search_and_exec`（コマンド探索と実行）
  - `src/builtin`（組み込みコマンド）
  - `src/env_management`（環境変数管理）
  - `src/data_management`（メモリ管理/アロケータ/ユーティリティ）
  - `src/signal_management`（シグナル初期化・ハンドリング）
  - `libft/`（プロジェクト供給のユーティリティ群）
- 相互依存とエラーモードまとめ
- 推奨テスト・検証項目
- 次の改善候補（小さな改善/追加仕様）

## 全体アーキテクチャ概要

高レベルでは、minishell は以下の流れで動作します。

1. 入力取得（対話: `ft_readline` / 非対話: `get_next_line`）
2. 字句解析（`lexer`）→ トークン列（ワードは**未展開**のまま保持）
3. トークン列から構文解析（`parser`）→ AST（コマンドツリー、ワードは**未展開**のまま保持）
4. 構文検査（`syntax_checker` 等）→ エラー処理
5. AST を実行（`executer`）:
   - **ここで初めてワード展開を実行**（環境変数展開、ワイルドカード展開）
   - 展開結果を argv として、ビルトイン / 外部コマンド実行、リダイレクト、パイプ、サブシェル、ヒアドキュメント 等
6. 実行結果を受け取り、シェル状態（例: last_exit_status）を更新

**重要な設計方針**: ワードの展開（`$VAR`, `$?`, `*` など）は **lexer や parser の段階では行わず**、executor がコマンドの argv を構築する直前にのみ実行します。これにより、lexer/parser の責務が明確になり、展開ロジックのテスト性が向上します。

各モジュールは上記の段階のいずれかに明確に対応します。

## 主要データ構造（概観）
- t_shell: シェルのグローバル状態（環境リスト、last_exit_status、プロンプト設定など）
- t_token: 字句解析トークン（type, value, フラグ、nextなど）— **ワードは未展開の生文字列として保持**
- t_word: **ワード展開時のみ使用する一時的な中間構造体**（executor が argv を構築する際に使用）
  - WD_LITERAL（リテラル文字列）、WD_DOLLER（変数展開）、WD_WILDCARD（ワイルドカード）などのタイプを持つ
  - lexer や parser の段階では使用せず、ft_expand_word() などの展開関数内でのみ生成・使用される
- t_env: 環境変数エントリ（key, value, exported フラグ, next）
- AST ノード（コマンドノード、オペレータノード、セパレータ等）— **ワードは未展開の文字列として保持**

（注）正確なフィールド名・構成は `includes/*.h` を参照してください。本書は機能的な視点に重点を置きます。

  - 入力引数の検証失敗 → 標準エラー出力へメッセージ、エラーコード返却
- テスト案:
  - export/unset の振る舞い（環境リストの変化）と標準出力/エラー

### src/env_management
- 役割:
  - 環境変数リストの作成、検索、設定、削除を提供
  - `find_env`, `set_variable`, `init_env` など
- 入出力:
  - 入力: key, value
  - 出力: t_env * リストの変更 or 新規作成
- テスト案:
  - 既存keyの上書き、存在しないkeyの追加、unset の挙動

### src/data_management
- 役割:
  - 汎用メモリアロケーションラッパー（xmalloc, xcalloc, xfree）
  - 各種構造体の alloc/free（alloc_t.c, free_t.c）
  - 再利用可能な小ユーティリティ
- 入出力:
  - 入力: サイズ／ポインタ
  - 出力: 確保済みメモリ / 成功・失敗
- テスト案:
  - メモリ割当／解放時のリークチェック

### src/signal_management
- 役割:
  - シグナル（SIGINT, SIGQUIT 等）の初期化とハンドリング
  - インタラクティブ時/子プロセス実行時で適切に挙動を切り替える
- テスト案:
  - SIGINT 受信時に期待するプロンプト復帰と child process の挙動

### libft/
- 役割:
  - プロジェクトで使用する共通ユーティリティ（文字列、メモリ、IO ヘルパー）
  - 42 標準的な ft_* 実装群
- 注意点:
  - 個々の `ft_*` は本ドキュメントの対象外だが、プロジェクトの安定性に寄与するため、API 互換と挙動の整合性は維持する

### tests/
- 役割:
  - 単体テスト / 統合テストのコード。CI またはローカルでの検証を担う
- 推奨:
  - 既存のテストを整理して、lexer/parser/executor それぞれのハピーパスと代表的エラーケースを明示的にカバーする

## 相互依存とエラーモードまとめ
- 文字列取得 → lexer: 入力が NULL の場合は即座に EOF 扱い。
- lexer → parser: 無効なトークン（未閉じクォート等）は parser 側で明示的に拒絶し、上位でエラーメッセージを出力する。
- parser → executer: 構文エラーがある場合は実行せずにエラーコードを返す。
- executer: フォーク/exec/dup2/pipe といったシステムコールの失敗は errno を参照し、ユーザ向けメッセージと適切な終了コードを返す。

## 推奨テスト・検証項目
1. 字句解析
  - 単純ワード、引用、複合メタ文字列、ダラー展開を含むケース。
2. 構文解析
  - パイプとリダイレクト混在、セミコロンでの複数コマンド、括弧（サブシェル）等。
3. 実行
  - パイプでつながれた複数コマンドと赤irectionの組合せ。
  - builtin の状態変化（cd, export など）。
4. ヒアドキュメント
  - 対話と非対話での挙動、終了デリミタの扱い。
5. シグナル
  - Ctrl-C と Ctrl-\ の処理が期待どおりか。

## 次の改善候補（小さな改善/追加仕様）
- 各モジュールに公開 API の簡潔なヘッダ（関数と期待値、失敗時の動作）を追加する。特に `lexer` → `parser`、`parser` → `executer` の契約を明文化。
- `word_expansion` の仕様ドキュメント（環境変数、特殊変数、ワイルドカードの優先順位と挙動）。
- 統合テストの自動化（CI に組み込み）。

---

このドキュメントは初版です。必要であれば、より細かな関数レベルや型定義（ヘッダ参照）を突合して追記します。どのモジュールをより詳細に展開したいか教えてください。

echo ""
echo" "
1.split by metachar. quotation turns off the metachar efficacy.
2.